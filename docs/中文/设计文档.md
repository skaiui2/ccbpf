## ccBPF设计文档

这是一个面向嵌入式系统的轻量级语言运行环境：
 **一个可在 MCU 上运行的编译器 + 虚拟机体系，灵感来自 eBPF，但更小、更简单、更可移植。**

它允许开发者在 RTOS、网络协议栈、文件系统等组件中插入动态 hook 代码，无需重新编译固件，从而实现灵活的扩展能力。

当然，也可以在Linux这些通用操作系统上使用，比如当一个可扩展的脚本语言。

实际上，通用操作系统上hook编程的工具不少，比如逆向经常用的frida，这些可以说是调试器级别的hook，也有各种脚本语言可用。

但是，这些语言的设计与ccBPF并不相同。

ccbpf的哲学是设计一种轻量级、可保证、动态、安全、可移植的程序扩展机制。

## 目标

我的目标是希望构建一套适用于 MCU 的 可扩展执行环境，包括：

- 一门极简但可用的语言，也就是c语言，但会去除一些不必要的文法和特性
- 一个完整的编译器（前端 + IR + 后端）
- 一个可移植的虚拟机，我移植的是4.4BSD-lite虚拟机
- 一个可执行文件格式（类似 ELF 的极简版本）
- 一个可在 RTOS 内部运行的hook 机制，类似 eBPF
- 让用户可以在运行时加载、执行、卸载小程序
- 可以在网络协议栈、文件系统、驱动层插入动态逻辑

目标是让 嵌入式环境具备：**可编程性**+ **可扩展性**+ **安全沙箱**而不是每次都重新烧录固件。

## 设计

目前已经完成了整个系统的基础设施：

### 语言与编译器

- 词法分析、语法分析、AST，前端参考的是龙书的代码及思路
- 中间表示 IR
- 后端三层架构，也就是layout 、 selection 、 controlflow
- IR 到 BPF 指令选择
- 完整的 BPF 指令生成器
- 可执行文件格式 `.ccbpf`（代码段 + 数据段 + 入口点）

###  虚拟机

- 经典 BPF 风格的 VM，直接从4.4BSD-lite移植而来，非常小
- 支持算术、逻辑、跳转、内存访问
- 支持从 `.ccbpf` 加载、执行、卸载
- 可在 Linux 用户态运行

###  运行

```
C 源码 → AST → IR → BPF → out.ccbpf → VM 执行
```

现在其实就是一个完整的轻量级编译器加虚拟机，你可以使用编译器在嵌入式等场景编写bpf c文件并且调用虚拟机执行文件。

## 语法支持

### 变量

必须在hook函数开头声明全部变量。

### 基本类型

只支持无符号整数，比如unsigned char，unsigned short，unsigned int,如果你只写int这些，也只会当成unsigned来处理。

### 结构体

支持结构体，但需要在hook函数前声明。

### 数组

支持基本的数组，但不支持二维数组。

### 指针

支持指针，基本用法：

```c
 uh = (struct udp_hdr *)&pkt[34];
 x = uh->sport;
```

### 本地调用

支持ntohs,ntohl和print。

## 使用示例

```c
struct udp_hdr {
    unsigned short sport;
    unsigned short dport;
};

int hook(void *ctx, char *pkt)
{
    unsigned int x;
    unsigned int y;
    struct udp_hdr *uh;

    uh = (struct udp_hdr *)&pkt[34];
    x = ntohs(uh->sport);
    print(x);
    y = uh->dport;
    print(y);
    return x + y;
}
```

## 动态hook

动态附加bpf程序，动态卸载等功能，还在支持中。

